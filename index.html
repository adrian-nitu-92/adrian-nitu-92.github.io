<head>
	<link href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet">
		</script>
		    <!-- lib -->
    <script type="text/javascript" src="libs/jquery-1.11.1.min.js" ></script>
    <script type="text/javascript" src="libs/underscore-min.js" ></script>
    <script type="text/javascript" src="libs/backbone-min.js" ></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js">
		</script>
		<script src="libs/pretty-json-min.js">
		</script>
		<script src="https://api.trello.com/1/client.js?key=83fbbffdca68e9e5655f409d9b204618">
		</script>
		<script src="https://apis.google.com/js/api.js">
		</script>
		<script src="rules.js">
		</script>
		<script src="google-common.js">
		</script>
		<script src="sheets.js">
		</script>
		<script src="calendar.js">
		</script>
		<script src="list.js">
		</script>
		<script src="trello.js">
		</script>
		<script src="card.js">
		</script>
		<script src="graph.js">
		</script>
		<script src="scheduler.js">
		</script>
		<!--  python -m http.server -->
	</link>
</head>
<body>
	<div id="mit"></div>
	<div id="quick" style="display: none;"><a href="./quick.html"> quick </a></div>

    <textarea id="airea" rows="1" cols="25">Other</textarea>
	<button id="start-button" >Start</button>

	<div id="percs" style="width: 640px; height: 480px;"></div>
	<button id="reset-button" style="display: block;">Reset</button>
	<div id="jayson"></div>
<table style="width:100%">
  <tr>
    <td>
	<div id="p1">Hello World!</div></td>
    <td><div id="p2"></div></td>
  </tr>
</table>

	<button id="end-button" style="display: block;">End Day</button>
	<button id="authorize-button" style="display: block;">Authorize</button>

	<script>

"use strict";
var debug = function( ar, mesage){
	if(ar){
		console.log(mesage);
	}
}

var authorizeButton = document.getElementById('authorize-button');

var resetButton = document.getElementById('reset-button');
resetButton.onclick = function(){
		localStorage.setItem("WeekStart", undefined);
		localStorage.setItem("TodayStart", undefined);
		localStorage.setItem("reset", undefined);
}

var startButton = document.getElementById('start-button');
startButton.onclick = function(){
		sheets.add();
}

var endbutton = document.getElementById('end-button');
var g_data = {errorCount:0};

var g_stuff = 0;
var mitMe = function(message){
	g_stuff = g_stuff + 1;
	if(g_stuff > 3){
		return;
	}
	var h = document.getElementById('mit').innerHTML;
	document.getElementById('mit').innerHTML = h + message + "<br/>";
}

var reallyOverdue = [];
var counter = 0; // TODO: no global state please
var moved = false;
var globalWarning = "";
var globalError = "";
var gItemID = undefined;
var cur=true;
var lists = {};
var listsData = {};
var incrementator;
var listthatneed;
var timethatlistneed;
var graph = new Graph();
var requiredLists = ["Today", "Tomorrow", "Week", "Month", "3 Month", "6 Month", "Year", "3 Year", "Inbox", "One Day"];

var addMessage = function(message){
	globalWarning = globalWarning + message;
}

var addWarning = function(message){
	globalWarning = globalWarning + message;
	g_data.errorCount = g_data.errorCount + 1;
}

var addError = function(message){
	globalWarning = globalWarning + message;
	globalError = globalError + message;
	g_data.errorCount = g_data.errorCount + 1;
}

var sortingDebug = false;

var doOver = function(){
	if(moved){
		// dont sort if at least one card has been moved
		return;
	}
	if(incrementator < arraySortedBySize.length){
		var card = arraySortedBySize[incrementator];
		incrementator = incrementator +1;
		var cVal = arraySortedByPos.indexOf(card);
		var value = "bottom";

		debug(sortingDebug, "Sorting");
		debug(sortingDebug, card.name + " " + card.size);
		Trello.put('/cards/' + card.id + "/pos",{"value":value},
			doOver, console.log);
	} else {
		window.location.reload();
	}
}
	var process_card = function(a, b){
		console.log(reallyOverdue[a].name + b);
	}
var getOut = function(){
	if(lists.Today.ticks > lists.Today.sumTicks){
		document.getElementById('quick').style.display = "";
	}

	for(var ro in reallyOverdue){
		var card  =  reallyOverdue[ro];
		document.getElementById("p2").innerHTML = document.getElementById("p2").innerHTML + card.name + "<br/>";

		document.getElementById("p2").innerHTML = document.getElementById("p2").innerHTML +
			'<button id="Done'+card.id+'" style="display: block;">Done</button>';
		document.getElementById("p2").innerHTML = document.getElementById("p2").innerHTML +
			'<button id="Skipped'+card.id+'" style="display: block;">Skipped</button>';
		document.getElementById("Done"+card.id).setAttribute("onclick", "process_card("+ro+", 'done');");
		document.getElementById("Skipped"+card.id).setAttribute("onclick", "process_card("+ro+", 'skipped');");

	}
	var myReqlist = requiredLists.slice(0,-2);
	var data = [];
	var colorme = function (a, type) {
		var colors = {"Work":'rgb(0,121,191)', "Unlabeled":'rgb(0,0,0)', "Free":'rgb(97,189,79)', "Facultate":'rgb(195,119,224)', "Facultate-TA":'rgb(195,119,224)', "DownTime":'rgb(0,194,224)', "Grow":'rgb(0,194,224)', "Social":'rgb(255,128,206)', "Health":'rgb(81,232,152)', "Weekly":'rgb(211,211,211)',"Project":'rgb(242,214,0)'};
		return colors[type];
	}
	for(var type in graph._sumsCount["3 Year"]){
		var Percs = {
			x: myReqlist.map(a => a + " " + lists[a].cardCount + "/" + lists[a].maxCount),
			y: myReqlist.map(a => graph.returnScaled(a, type, lists[a].ticks)),
			type: 'bar',
			name: type,
			marker:{
				color: myReqlist.map(a => colorme(a, type))
			},
		};
		data.push(Percs);
	};
	var layout = {
		barmode: 'stack',
		xaxis: {tickfont: {
			size: 17,
		}},
		legend: {
			y: 0.5,
		//traceorder: 'reversed',
		font: {size: 16},
		yref: 'paper',
		}};
	data.reverse();
	console.log(graph._sumsCount);
	Plotly.newPlot('percs', data, layout);
	var node = new PrettyJSON.view.Node({
	  el:$('#jayson'),
	  data:listsData
	});
}

var done = function(){
	document.getElementById("p1").innerHTML = "";
	counter = counter + 1;
	if(cur) {
		GclientInit();
		cur = false;
	}
	if(counter >= Object.keys(lists).length +1){
		var prevFree = 0;
		for(var l in requiredLists){
			var name = requiredLists[l];
			if(! trelloApi.parseTasks(lists[name])){
				document.getElementById("p1").innerHTML = globalError;
				return getOut();
			}
		}

	if(onceADayFlag && ! justReset){
		// move all cards to inbox
		// move_all_cards_in_range(0, lists["Today"].start, lists["Today"], lists["Inbox"]);
		move_all_cards_in_range(lists["Today"].start, lists["Tomorrow"].start, lists["Tomorrow"], lists["Today"]);
		move_all_cards_in_range(lists["Tomorrow"].start, lists["Tomorrow"].end, lists["Week"], lists["Tomorrow"]);
	}

	for(var a in asserts){
		var assert = asserts[a];
		console.log(a);
		if(! assert(lists)){
			document.getElementById("p1").innerHTML = globalError;
			return getOut();
		}
	}

	var aaaux = "You currently have <b>" + g_data.errorCount + "</b> errors<br>" +
	"Inbox costs around <b>" + lists["Inbox"].sumTicks + "</b> hours <br/> ";
	if(listthatneed !== undefined) {
		aaaux = aaaux + listthatneed + " needs at least <b>" + timethatlistneed + "</b> hours <br/> " ;
	}
	/* add it to the begining */
	globalWarning = aaaux + globalWarning;
//---------------------------
	getOut();
//-----------------------------
}
document.getElementById("p1").innerHTML = document.getElementById("p1").innerHTML + globalWarning;
globalWarning = "";

}
var populateLists = function(){
	var curry = function(listName){
		var tarray = requiredLists.slice(0);
		tarray.push("Done");
		if( ! tarray.includes(listName) ){
			return done;
		}
		return function(answer) {
			var cards = {};
			for(var i in answer){
				var card = answer[i];
				cards[card.id] = new Card(card, listName);
			}
			lists[listName].cards = cards;
			lists[listName].cardCount = Object.keys(cards).length;
			done();
		};
	};
	for(var listName in lists){
		var listID = lists[listName].id;
		Trello.get('/lists/'+ listID +'/cards', curry(listName), console.log);
	}

	console.log(lists);
}

var llllll;
var boardSelect = function(boardID){
	var success = function(answer) {
		llllll = answer;
		document.getElementById("p1").innerHTML = "";
		for(var i in answer){
			var list = answer[i];

			list.backlink = list;
			if(lists[list.name] === undefined){
				lists[list.name] = list;
			} else {
				Object.assign(lists[list.name], list);
			}
		}
		populateLists();
	};

	Trello.get('/boards/51d3f043a536c77a09000a40/lists', success, console.log);
}

var justReset;

function base(){

	justReset = (localStorage.getItem("reset") === "undefined");

	localStorage.setItem("reset", "value");

	Trello.authorize({
		type: 'popup',
		name: 'Getting Started Application',
		scope: {
			read: 'true',
			write: 'true' },
			expiration: 'never',
			success: every5,
			error: console.log
		});

}

var onceADayFlag = false;
var onceAWeekFlag = false;

var todayStart;
var weekStart;
var scoreMultiplier;
var mult;

var move_all_cards_in_range = function(start, end, l1, l2){
	for (var c in l1.cards) {
		var card = l1.cards[c];
		if(card.date > start && card.date < end) {
			if(l2.canTakeCard(card)){
				l2.takeCardFrom(card, l1);
			}
		}
	}
}

function every5(){
	moved = false;
	lists = {};

	var dayLenghtInMs = (1000 * 60 * 60 * 24);
	var weekLengthInMs = (dayLenghtInMs * 7);

	var timezoneOffset = 3*60*60*1000; // We need 3 extra hours for the timezone setting

	var nowDate = new Date();
	var now = nowDate.getTime() + timezoneOffset;

	/* let todayStart be global */
	todayStart = now - now % dayLenghtInMs;
	var currentHour = ((nowDate.getTime()) - todayStart + timezoneOffset) / (1000 * 60 * 60);
	currentHour = Math.round(Number(currentHour*4))/4;
	if(currentHour >= 24){
		currentHour -= 24;
		todayStart = todayStart + dayLenghtInMs;
	}
	if (currentHour < 7) {
		currentHour = 7;
	}

	var auxStart = localStorage.getItem("AuxStart");
	if(auxStart > todayStart){
		todayStart = parseInt(auxStart);
		currentHour = 7;
	}

	var aux = (todayStart + 3.5 * dayLenghtInMs);
	/* let weekStart be global */
	weekStart = aux - aux % (7 * dayLenghtInMs) - 3 * dayLenghtInMs; /* because 1 Jan 1970 was a Thursday */

	var localStorageWeekStart = localStorage.getItem("WeekStart");
	if(localStorageWeekStart != weekStart){
		localStorage.setItem("WeekStart", weekStart);
		onceAWeekFlag = true;
		console.log("Working for once this week");
	} else {
		console.log("Already worked this week");
	}

	var localStorageTodayStart = localStorage.getItem("TodayStart");
	if(localStorageTodayStart != todayStart){
		localStorage.setItem("TodayStart", todayStart);
		onceADayFlag = true;
		console.log("Working for once today");
	} else {
		console.log("Already worked today");
	}

	var baseDay = 12;
	var normalDay = 17;
	var weekHabbitOffset = (normalDay - baseDay)*7;

	var yesterStart   = todayStart - dayLenghtInMs;
	var tomorrowStart = todayStart + dayLenghtInMs;
	var tomorrowEnd   = todayStart +           2 * dayLenghtInMs;
	var weekEnd       = weekStart  +           7 * dayLenghtInMs;
	if(weekEnd === tomorrowStart) {
		weekEnd = weekEnd + 7 * dayLenghtInMs;
	}
	var monthEnd      = todayStart +          31 * dayLenghtInMs;
	var _3monthEnd    = todayStart +      3 * 31 * dayLenghtInMs;
	var _6monthEnd    = todayStart +      6 * 31 * dayLenghtInMs;
	var yearEnd       = todayStart +     12 * 31 * dayLenghtInMs;
	var _3yearEnd     = todayStart + 3 * 12 * 31 * dayLenghtInMs;

	var daysInThisWeek = (weekEnd - todayStart) / dayLenghtInMs;

	var todayLen    = 24 - currentHour;
	var tomorrowLen = normalDay;
	var weekLen     = normalDay * (daysInThisWeek -1);
	var nWeekLen    = baseDay*7+weekHabbitOffset;
	// add 30 hours as an overlap buffer -- this should protect from the need to push out a ww prematurely
	var monLen      = baseDay * 31 + weekHabbitOffset + 30;
	var _3monLen    = monLen *3 + weekHabbitOffset;
	var _6monLen    = monLen *6 + weekHabbitOffset;
	var yearLen     = baseDay * 365 + weekHabbitOffset;
	var _3yearLen   = yearLen *3 + weekHabbitOffset;

	if(true) {
		var baseMonthInt = 7;
		var baseYearInt = 17;

		var monEndInt;
		var _3monEndInt;
		var _6monthInt;
		var yearInt;
		var _3yearEnd;

		var computeDate = function (monthInt, yearInt, monthPush, min)
		{;
			var ret;
			ret = new Date(0);
			while(ret < min) {
				monthInt = monthInt + monthPush;
				while(monthInt > 12){
					yearInt = yearInt + 1;
					monthInt = monthInt - 12;
				}
				ret = new Date(monthInt+"/1/"+yearInt+" GMT");
			}
			return ret;
		}
		var getDays = function(stop, start){
			return (stop - start)/dayLenghtInMs -1;
		}
		var max = function(a,b){
			if (a>b)
				return a;
			return b;
		}
		monthEnd = computeDate(baseMonthInt, baseYearInt, 1,  weekEnd).getTime();

		if(monthEnd	- weekEnd < 7 * dayLenghtInMs) {
					monLen = weekLen;
		}
		var aux = weekEnd;
		while(aux < monthEnd) {
			aux = aux + 7 * dayLenghtInMs;
		}
		monthEnd = aux;

		_3monthEnd = computeDate(baseMonthInt, baseYearInt, 3,  weekEnd).getTime();
		_6monthEnd = computeDate(baseMonthInt, baseYearInt, 6,  weekEnd).getTime();
		yearEnd    = computeDate(baseMonthInt, baseYearInt, 12, weekEnd).getTime();
		_3yearEnd  = computeDate(baseMonthInt, baseYearInt, 36, weekEnd).getTime();

		_3monthEnd = max(_3monthEnd,   monthEnd);
		_6monthEnd = max(_3monthEnd, _6monthEnd);
		yearEnd    = max(   yearEnd, _6monthEnd);
		_3yearEnd  = max( _3yearEnd,    yearEnd);

		monLen    = baseDay * getDays(  monthEnd, todayStart) + weekHabbitOffset;
		_3monLen  = baseDay * getDays(_3monthEnd, todayStart) + weekHabbitOffset;
		_6monLen  = baseDay * getDays(_6monthEnd, todayStart) + weekHabbitOffset;
		yearLen   = baseDay * getDays(   yearEnd, todayStart) + weekHabbitOffset;
		_3yearLen = baseDay * getDays( _3yearEnd, todayStart) + weekHabbitOffset;
	}

	var maxInt = Number.MAX_SAFE_INTEGER;


	scoreMultiplier = {};
	mult = 1.5;
	scoreMultiplier["Today"]     = mult = mult /1.5;
	scoreMultiplier["Tomorrow"]  = mult = mult /1.5;
	scoreMultiplier["Week"]      = mult = mult /1.5;
	scoreMultiplier["Month"]     = mult = mult /1.5;
	scoreMultiplier["3 Month"]   = mult = mult /1.5;
	scoreMultiplier["6 Month"]   = mult = mult /1.5;
	scoreMultiplier["Year"]      = mult = mult /1.5;
	scoreMultiplier["3 Year"]    = mult = mult /1.5;
	scoreMultiplier["Inbox"]     = mult = mult /1.5;
	scoreMultiplier["One Day"]   = mult = mult /1.5;

	var maxTaskDay = 25;

	lists["Today"]     = new List("Today",       todayStart, tomorrowStart,    todayLen,  ONCE_A_DAY,       null,         null,  sortTime,     maxTaskDay, 3);
	lists["Tomorrow"]  = new List("Tomorrow", tomorrowStart,   tomorrowEnd, tomorrowLen,  ONCE_A_DAY,    "Today",       "Week", sortScore,     maxTaskDay, 2);
	lists["Week"]      = new List("Week",       tomorrowEnd,       weekEnd,     weekLen,  ONCE_A_DAY, "Tomorrow",      "Month", sortScore,    maxTaskDay * (daysInThisWeek-1), 14);
	lists["Month"]     = new List("Month",          weekEnd,      monthEnd,      monLen, ONCE_A_WEEK,     "Week",    "3 Month", sortScore,    200, 10);
	lists["3 Month"]   = new List("3 Month",       monthEnd,    _3monthEnd,    _3monLen, ONCE_A_WEEK,    "Month",    "6 Month", sortScore,    250, 10);
	lists["6 Month"]   = new List("6 Month",     _3monthEnd,    _6monthEnd,    _6monLen, ONCE_A_WEEK,  "3 Month",       "Year", sortScore,    300, 10);
	lists["Year"]      = new List("Year",        _6monthEnd,       yearEnd,     yearLen, ONCE_A_WEEK,  "6 Month",     "3 Year", sortScore,    350, 10);
	lists["3 Year"]    = new List("3 Year",         yearEnd,     _3yearEnd,   _3yearLen, ONCE_A_WEEK,     "Year",    "One Day", sortScore,    400, 10);
	lists["One Day"]   = new List("One Day",      _3yearEnd,        maxInt,      maxInt,       NEVER,   "3 Year",         null, sortScore, maxInt, undefined);
	lists["Inbox"]     = new List("Inbox",                0,        maxInt,      maxInt,       NEVER,       null,         null, sortScore, maxInt, undefined);
	lists["Done"]      = new List("Done",                 0,        maxInt,      maxInt,       NEVER,       null,         null, sortScore, maxInt, undefined);
	boardSelect(gItemID);

	endbutton.onclick = function(){
		localStorage.setItem("AuxStart", tomorrowStart);
	}

	setInterval(function() {window.location.reload();}, 1000*60*10);
}
base();
	</script>
	<script src="https://cdn.plot.ly/plotly-latest.min.js">
	</script>
</body>
